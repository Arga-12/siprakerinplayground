<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siprakerin Playground</title>
    <link href="/output.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
        }

        .font-mono {
            font-family: 'Fira Code', monospace;
        }

        /* Custom Scrollbar for Logs */
        #log-container::-webkit-scrollbar {
            width: 6px;
        }

        #log-container::-webkit-scrollbar-track {
            background: #1f2937;
        }

        #log-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        #log-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen overflow-hidden flex items-center justify-center p-6 md:p-12 relative">

    <!-- Background Decoration -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-200 rounded-full blur-[100px] opacity-40">
        </div>
        <div
            class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-200 rounded-full blur-[100px] opacity-40">
        </div>
    </div>


    <!-- Main Container (Floating) -->
    <div class="relative z-10 w-full h-full flex gap-6">

        <!-- Left: Floating Log Card -->
        <aside
            class="w-1/3 bg-gray-900 text-green-400 rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-gray-800 backdrop-blur-sm bg-opacity-95">
            <div class="p-6 border-b border-gray-800 bg-gray-900/50 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-bold tracking-widest text-gray-500">System Logs</h3>
                    <div class="text-[10px] text-gray-600 font-mono mt-1">Live fetch & status</div>
                </div>
                <div class="flex space-x-1.5">
                    <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500/80"></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 font-mono text-xs space-y-3" id="log-container">
                <% logs.forEach(log=> { %>
                    <div class="opacity-80 hover:opacity-100 transition-opacity flex items-start">
                        <span class="text-gray-600 mr-2 shrink-0">[<%= log.time %>]</span>
                        <span
                            class="<%= log.type === 'INFO' ? 'text-blue-400' : (log.type === 'FETCH' ? 'text-purple-400' : (log.type === 'AUTH' ? 'text-yellow-500' : 'text-green-400')) %> font-bold mr-2 shrink-0">
                            <%= log.type %>
                        </span>
                        <span class="text-gray-300 break-words">
                            <%= log.message %>
                        </span>
                    </div>
                    <% }) %>
                        <div class="animate-pulse text-green-500">_</div>
            </div>

            <div class="p-4 bg-gray-900/50 border-t border-gray-800 text-[10px] text-gray-600 font-mono text-center">
                env: Siprakerin SMKN 4 MALANG | 4rgandull-experiments
            </div>
        </aside>


        <!-- Right: Floating Main Content -->
        <main class="flex-1 flex flex-col shadow-3xl overflow-hidden relative">

            <!-- Main Card -->
            <div
                class="flex-1 bg-white/90 rounded-3xl border border-white/20 flex flex-col overflow-hidden relative">

                <!-- Title Header -->
                <div class="px-8 p-6 border-b border-gray-100 flex items-center justify-center">
                    <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                        Fetching Siprakerin's Supabase Playground
                    </h1>
                </div>

                <!-- Student Info & Content -->
                <div class="flex-1 overflow-y-auto p-8 pt-6">
                    <div class="max-w mx-auto space-y-8">

                        <!-- Feedback Messages -->
                        <% if (message) { %>
                            <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm">
                                <p class="text-sm text-green-700 font-medium">
                                    <%= message %>
                                </p>
                            </div>
                            <% } %>
                                <% if (error) { %>
                                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 shadow-sm">
                                        <p class="text-sm text-red-700 font-medium">
                                            <%= error %>
                                        </p>
                                    </div>
                                    <% } %>

                                        <!-- Vertical Data List (Data Formulir) -->
                                        <div
                                            class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                                            <div
                                                class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-4 border-b border-gray-100">
                                                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider">
                                                    Data Formulir</h3>
                                            </div>
                                            <div class="divide-y divide-gray-100">
                                                <!-- Item: Nama -->
                                                <div
                                                    class="px-6 py-3 flex items-center hover:bg-gray-50 transition-colors">
                                                    <span
                                                        class="w-32 text-xs font-semibold text-gray-400 uppercase">Nama
                                                        Lengkap</span>
                                                    <span class="flex-1 text-sm font-medium text-gray-900">
                                                        <%= defaults.nama || '-' %>
                                                    </span>
                                                </div>
                                                <!-- Item: NIS -->
                                                <div
                                                    class="px-6 py-3 flex items-center hover:bg-gray-50 transition-colors">
                                                    <span
                                                        class="w-32 text-xs font-semibold text-gray-400 uppercase">NIS</span>
                                                    <span class="flex-1 text-sm font-medium text-gray-900">
                                                        <%= defaults.nis || '-' %>
                                                    </span>
                                                </div>
                                                <!-- Item: Keahlian -->
                                                <div
                                                    class="px-6 py-3 flex items-center hover:bg-gray-50 transition-colors">
                                                    <span
                                                        class="w-32 text-xs font-semibold text-gray-400 uppercase">Keahlian</span>
                                                    <span class="flex-1 text-sm font-medium text-gray-900">
                                                        <%= defaults.keahlian || '-' %>
                                                    </span>
                                                </div>
                                                <!-- Item: Kelas -->
                                                <div
                                                    class="px-6 py-3 flex items-center hover:bg-gray-50 transition-colors">
                                                    <span
                                                        class="w-32 text-xs font-semibold text-gray-400 uppercase">Kelas</span>
                                                    <span class="flex-1 text-sm font-medium text-gray-900">
                                                        <%= defaults.id_kelas || '-' %>
                                                    </span>
                                                </div>
                                                <!-- Item: Industri -->
                                                <div
                                                    class="px-6 py-3 flex items-center hover:bg-gray-50 transition-colors">
                                                    <span
                                                        class="w-32 text-xs font-semibold text-gray-400 uppercase">Industri</span>
                                                    <span class="flex-1 text-sm font-medium text-gray-900">
                                                        <%= defaults.nama_industri || '-' %>
                                                    </span>
                                                </div>
                                            </div>
                                            <% if (!defaults.nama) { %>
                                                <div
                                                    class="px-6 py-2 bg-yellow-50 text-[10px] text-yellow-600 text-center">
                                                    Data sedang diambil dari database...
                                                </div>
                                                <% } %>
                                        </div>

                                        <!-- Input Form -->
                                        <form action="/submit" method="POST" class="space-y-6">

                                            <!-- Tanggal Input -->
                                            <div>
                                                <label for="tanggal"
                                                    class="block text-sm font-medium text-gray-700 mb-2 ml-1">Tanggal</label>
                                                <input type="date" id="tanggal" name="tanggal" required
                                                    class="w-full px-4 py-3 rounded-2xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all duration-200 bg-gray-50 focus:bg-white text-sm shadow-sm font-medium text-gray-700">
                                            </div>

                                            <div>
                                                <label for="kegiatan"
                                                    class="block text-sm font-medium text-gray-700 mb-2 ml-1">Kegiatan
                                                    Hari
                                                    Ini</label>
                                                <textarea id="kegiatan" name="kegiatan" rows="3" required
                                                    class="w-full px-4 py-3 rounded-2xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all duration-200 bg-gray-50 focus:bg-white resize-none text-sm placeholder-gray-400 shadow-sm"
                                                    placeholder="Jelaskan aktivitas prakerin kamu hari ini..."></textarea>
                                            </div>

                                            <div>
                                                <label for="keterangan"
                                                    class="block text-sm font-medium text-gray-700 mb-2 ml-1">Status
                                                    Kehadiran</label>
                                                <div class="relative">
                                                    <select id="keterangan" name="keterangan"
                                                        class="w-full appearance-none px-4 py-3 rounded-2xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all duration-200 bg-gray-50 focus:bg-white cursor-pointer text-sm shadow-sm font-medium text-gray-700">
                                                        <option value="hadir" selected>Hadir</option>
                                                        <option value="libur">Libur</option>
                                                    </select>
                                                    <div
                                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                                        ▼
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="submit"
                                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-2xl shadow-xl shadow-indigo-200 hover:shadow-2xl hover:shadow-indigo-300 hover:-translate-y-1 transition-all duration-300 flex items-center justify-center">
                                                <span class="tracking-wide">KIRIM LAPORAN</span>
                                            </button>
                                        </form>

                                        <!-- Daftar Izin Section -->
                                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden"
                                            id="izin-section">
                                            <div
                                                class="bg-gradient-to-r from-yellow-50 to-orange-50 px-6 py-4 border-b border-gray-100">
                                                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider">
                                                    Daftar Izin Saya</h3>
                                            </div>
                                            <div class="p-6">
                                                <div id="izin-container" class="space-y-3">
                                                    <div class="text-center py-4 text-gray-400 text-sm">
                                                        Memuat data izin...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Daftar Jurnal Section -->
                                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden"
                                            id="journal-section">
                                            <div
                                                class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-4 border-b border-gray-100">
                                                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider">
                                                    Riwayat Jurnal</h3>
                                            </div>
                                            <div class="overflow-x-auto">
                                                <table class="w-full text-sm">
                                                    <thead class="bg-gray-50 text-xs text-gray-500">
                                                        <tr>
                                                            <th class="px-4 py-3 text-left font-semibold">Tanggal</th>
                                                            <th class="px-4 py-3 text-left font-semibold">Kegiatan</th>
                                                            <th class="px-4 py-3 text-center font-semibold">Status</th>
                                                            <th class="px-4 py-3 text-center font-semibold">Hapus</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="journal-tbody" class="divide-y divide-gray-100">
                                                        <tr>
                                                            <td colspan="3" class="px-4 py-6 text-center text-gray-400">
                                                                Memuat data jurnal...
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Disclaimer & License Section -->
                                        <div class="p-6 mt-6">
                                            <div class="text-center mb-4">
                                                <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-2">Disclaimer & License</h4>
                                                <div class="h-0.5 w-20 bg-indigo-500 mx-auto"></div>
                                            </div>
                                            <div class="space-y-3 text-xs text-gray-600 leading-relaxed">
                                                <p class="text-center">
                                                    <strong class="text-gray-800">Experimental Project</strong> - This is a learning playground for exploring Supabase APIs and web automation <em> (not-yet tehe)</em>.
                                                </p>
                                                <p class="text-center">
                                                    Built for educational purposes only. This project demonstrates data fetching, authentication, and CRUD operations with Supabase.
                                                </p>
                                                <div class="pt-3 border-t border-gray-200 text-center">
                                                    <p class="font-medium text-gray-700">
                                                        © 2026 <strong>4rgandull</strong> - All Rights Reserved
                                                    </p>
                                                    <p class="text-gray-500 mt-1">
                                                        Licensed for personal and educational use only.
                                                    </p>
                                                </div>
                                                <p class="text-center text-gray-500 italic pt-2">
                                                    Reminder: Secure your Supabase API keys and review Row Level Security (RLS) policies. <3
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- prettier-ignore -->
    <script>
        const logContainer = document.getElementById('log-container');

        function getStatusColor(type) {
            switch (type) {
                case 'INFO': return 'text-blue-400';
                case 'FETCH': return 'text-purple-400';
                case 'AUTH': return 'text-yellow-500';
                case 'WARN': return 'text-yellow-400';
                case 'ERROR': return 'text-red-500';
                case 'FATAL': return 'text-red-600 bg-red-100 px-1';
                case 'SUCCESS': return 'text-green-400';
                case 'READY': return 'text-green-300 font-bold';
                default: return 'text-gray-400';
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();

                let html = '';
                logs.forEach(log => {
                    html += `
                        <div class="opacity-90 hover:opacity-100 transition-opacity flex items-start mb-2">
                            <span class="text-gray-600 mr-2 shrink-0 text-[10px]">[${log.time}]</span> 
                            <span class="${getStatusColor(log.type)} font-bold text-xs mr-2 shrink-0">${log.type}</span>
                            <span class="text-gray-300 break-words text-xs leading-relaxed">${log.message}</span>
                        </div>
                    `;
                });
                html += '<div class="animate-pulse text-green-500 mt-2">_</div>';

                if (logContainer.innerHTML !== html) {
                    const shouldScroll = logContainer.scrollTop + logContainer.clientHeight >= logContainer.scrollHeight - 20;
                    logContainer.innerHTML = html;
                    if (shouldScroll) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            } catch (e) {
                console.error("Failed to fetch logs", e);
            }
        }

        setInterval(fetchLogs, 1000);
        fetchLogs();

        // Format date to Indonesian format (DD-MM-YYYY)
        function formatIndonesianDate(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}-${month}-${year}`;
        }

        // Fetch and display journal data
        async function fetchJournalData() {
            try {
                const response = await fetch('/api/journals');
                const data = await response.json();

                // Render Izin/Permissions
                const izinContainer = document.getElementById('izin-container');
                if (data.permissions && data.permissions.length > 0) {
                    let izinHTML = '';
                    data.permissions.forEach(izin => {
                        izinHTML += `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center mb-2">
                                    <span class="ml-2 text-xs font-semibold text-gray-700">${formatIndonesianDate(izin.tanggal)}</span>
                                </div>
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-900 mb-1">Alasan Izin:</p>
                                    <p class="text-sm text-gray-700 leading-relaxed">${izin.alasan}</p>
                                </div>
                                <div class="mt-3 pt-3 border-t border-yellow-200">
                                    <p class="text-xs text-gray-500">
                                        <span class="font-medium">Dikirim:</span> ${new Date(izin.created_at).toLocaleString('id-ID')}
                                    </p>
                                </div>
                            </div>
                        `;
                    });
                    izinContainer.innerHTML = izinHTML;
                } else {
                    izinContainer.innerHTML = '<div class="text-center py-6 text-gray-400 text-sm">Belum ada data izin</div>';
                }

                // Render Journals
                const journalTbody = document.getElementById('journal-tbody');
                if (data.journals && data.journals.length > 0) {
                    let journalHTML = '';
                    data.journals.forEach(journal => {
                        const statusClass = {
                            'hadir': 'bg-green-100 text-green-800',
                            'izin': 'bg-yellow-100 text-yellow-800',
                            'sakit': 'bg-red-100 text-red-800',
                            'alpa': 'bg-gray-100 text-gray-800',
                            'libur': 'bg-blue-100 text-blue-800'
                        }[journal.keterangan] || 'bg-gray-100 text-gray-800';

                        journalHTML += `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 text-gray-900 font-medium whitespace-nowrap">${formatIndonesianDate(journal.tanggal)}</td>
                                <td class="px-4 py-3 text-gray-700">
                                    <div class="max-w-xs truncate" title="${journal.kegiatan}">
                                        ${journal.kegiatan}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${journal.keterangan.charAt(0).toUpperCase() + journal.keterangan.slice(1)}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="deleteJournalEntry(${journal.id})" 
                                        class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Hapus">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    journalTbody.innerHTML = journalHTML;
                } else {
                    journalTbody.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">Belum ada data jurnal</td></tr>';
                }
            } catch (e) {
                console.error("Failed to fetch journal data", e);
            }
        }

        // Fetch journal data on page load
        fetchJournalData();

        // Set today's date as default for tanggal input
        const tanggalInput = document.getElementById('tanggal');
        if (tanggalInput && !tanggalInput.value) {
            const today = new Date().toISOString().split('T')[0];
            tanggalInput.value = today;
        }

        // Delete Journal Entry
        async function deleteJournalEntry(id) {
            if (!confirm('Apakah kamu yakin ingin menghapus jurnal ini?')) {
                return;
            }

            try {
                const response = await fetch(`/api/journal/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Berhasil menghapus jurnal');
                    fetchJournalData(); // Refresh list
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Terjadi kesalahan: ' + err.message);
            }
        }

        // Make function globally accessible
        window.deleteJournalEntry = deleteJournalEntry;
    </script>
</body>

</html>